# Avatar Integration - Complete Implementation ✅

## Overview
Talentis.ai now features AI-powered avatar interviews using HeyGen API for realistic text-to-speech with lip sync animations.

## Backend Implementation

### New Endpoints

#### 1. POST `/api/interview/avatar`
Generate AI avatar video asking interview questions.

**Request:**
```json
{
  "questions": [
    "Tell me about your experience with Python",
    "Describe a challenging project you worked on"
  ],
  "avatar_id": "default"  // Optional: HeyGen avatar ID
}
```

**Response:**
```json
{
  "video_url": "https://heygen.com/videos/abc123.mp4",
  "video_id": "abc123",
  "status": "completed"
}
```

**Features:**
- Uses HeyGen API for professional avatar generation
- Text-to-speech with natural lip sync
- Graceful fallback to demo URL if API key not configured
- Async video generation with polling

#### 2. POST `/api/interview/start` (Enhanced)
Now includes avatar video generation automatically.

**Response (Updated):**
```json
{
  "interview_id": 123,
  "questions": [
    {
      "question_id": 1,
      "question_text": "Describe your experience with Python...",
      "category": "technical"
    },
    {
      "question_id": 6,
      "question_text": "Tell me about a time you handled stress...",
      "category": "behavioral"
    }
  ],
  "language": "en",
  "avatar_video_url": "https://heygen.com/videos/abc123.mp4"
}
```

**New Features:**
- Generates 5 technical + 5 behavioral questions (10 total)
- Behavioral questions use Grok-3 with JD-specific prompts
- Avatar video generated automatically (optional, non-blocking)
- Interview proceeds even if avatar generation fails

### New AI Engine Functions

#### `generate_behavioral_questions(jd_text: str, count: int = 5)`
Located in `backend/ai_engine.py`

**Features:**
- Uses Grok-3 to generate context-aware behavioral questions
- STAR method framework (Situation, Task, Action, Result)
- Questions start with "Tell me about a time..." or "Describe a situation..."
- Tailored to job requirements and challenges
- Intelligent fallback questions when API unavailable

**Example Questions Generated:**
```python
[
  {
    "question_id": 1,
    "question_text": "Tell me about a time you handled a stressful situation at work and how you managed it.",
    "category": "behavioral"
  },
  {
    "question_id": 2,
    "question_text": "Describe a situation where you had to work with a difficult team member. How did you handle it?",
    "category": "behavioral"
  }
]
```

## Configuration

### Environment Variables

Add to `backend/.env`:
```env
# HeyGen API for Avatar Generation (Optional)
HEYGEN_API_KEY=your_heygen_api_key_here

# Grok-3 AI for Question Generation
XAI_API_KEY=your_xai_api_key_here
XAI_BASE_URL=https://api.x.ai/v1
```

### Free HeyGen API Access
1. Sign up at: https://www.heygen.com/
2. Navigate to API settings
3. Generate API key (free tier available)
4. Free tier includes: 5 credits, basic avatars, 720p video

### Without API Key
- System returns demo/mock video URL
- Interview proceeds normally
- All features work, just without real avatar generation

## Technical Details

### HeyGen Integration Flow
1. **Question Collection**: Extract question texts from AI-generated list
2. **Script Creation**: Combine questions with pauses ("...")
3. **API Request**: POST to HeyGen with avatar settings
4. **Async Generation**: Video generation happens in background
5. **Polling**: Check status every 10 seconds (max 5 minutes)
6. **URL Return**: Once complete, video URL embedded in response

### Avatar Configuration
```python
{
  "character": {
    "type": "avatar",
    "avatar_id": "default",  # Can customize
    "avatar_style": "normal"
  },
  "voice": {
    "type": "text",
    "input_text": "Question 1... Question 2...",
    "voice_id": "en-US-JennyNeural"  # Azure TTS
  },
  "background": {
    "type": "color",
    "value": "#FFFFFF"
  },
  "dimension": {
    "width": 1280,
    "height": 720
  }
}
```

## Interview Question Mix

### Technical Questions (5)
- Generated by `generate_interview_questions()`
- Based on job title and required skills
- Focus on: experience, projects, technical depth
- Example: "Describe your experience with FastAPI..."

### Behavioral Questions (5)
- Generated by `generate_behavioral_questions()`
- Based on full job description
- STAR method framework
- Assess: leadership, teamwork, stress management, conflict resolution
- Example: "Tell me about a time you handled a tight deadline..."

## Dependencies Added

```txt
httpx==0.25.2  # Async HTTP client for HeyGen API
```

## Error Handling

### Graceful Degradation
1. **No API Key**: Returns mock video URL, continues normally
2. **API Failure**: Catches exception, logs warning, returns fallback
3. **Timeout**: Max 5 minutes polling, then returns error
4. **Network Issues**: Falls back to demo URL

### Non-Blocking Design
- Avatar generation doesn't block interview start
- Interview can proceed without avatar
- Errors logged but don't break workflow

## Usage Example

### From Frontend
```javascript
// Start interview with avatar
const response = await axios.post('/api/interview/start', {
  match_id: 123
}, {
  headers: { Authorization: `Bearer ${token}` }
});

// Response includes avatar video
const {
  interview_id,
  questions,
  avatar_video_url  // Can be null if generation failed
} = response.data;

// Display avatar video in interview room
if (avatar_video_url) {
  videoElement.src = avatar_video_url;
}
```

### Direct Avatar Generation
```javascript
// Generate avatar for custom questions
const response = await axios.post('/api/interview/avatar', {
  questions: [
    "What's your biggest strength?",
    "Where do you see yourself in 5 years?"
  ],
  avatar_id: "professional_female_1"
}, {
  headers: { Authorization: `Bearer ${token}` }
});

const { video_url, video_id, status } = response.data;
```

## Testing

### Without API Key (Demo Mode)
```bash
# Start backend without HEYGEN_API_KEY
cd backend
uvicorn main:app --reload

# Test endpoint
curl -X POST http://localhost:8000/api/interview/avatar \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "questions": ["Test question 1", "Test question 2"]
  }'

# Returns: mock video URL
```

### With API Key (Production)
```bash
# Set environment variable
export HEYGEN_API_KEY=your_key_here

# Start backend
uvicorn main:app --reload

# Test endpoint - generates real avatar video
curl -X POST http://localhost:8000/api/interview/avatar \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "questions": ["Tell me about yourself"],
    "avatar_id": "default"
  }'
```

## Next Steps

### Frontend Integration
1. Update `InterviewRoom.jsx` to show avatar video
2. Add video player with avatar playback
3. Sync question display with avatar speech
4. Add loading state during avatar generation

### Enhanced Features
- Multiple avatar options (male/female, different styles)
- Language-specific voices (multilingual support)
- Custom avatar branding for employers
- Avatar gestures and expressions
- Background customization

## Files Modified

✅ `backend/requirements.txt` - Added httpx
✅ `backend/ai_engine.py` - Added `generate_behavioral_questions()`
✅ `backend/main.py` - Added avatar endpoint and enhanced interview start
✅ Schemas updated with `avatar_video_url` field

## Status: LIVE ✅

All features deployed and running:
- Backend at http://localhost:8000
- Avatar endpoint: `/api/interview/avatar`
- Enhanced interview start: `/api/interview/start`
- Behavioral questions integrated
- Graceful fallbacks active
